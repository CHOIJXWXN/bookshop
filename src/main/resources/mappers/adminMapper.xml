<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bookshop.mappers.admin">

	<!-- 각 페이지의 마지막 주문번호 -->
	<select id="getLastOrderNum" resultType="string">
		SELECT E.order_num FROM (
			SELECT C.order_num, C.user_id, C.book_id, D.book_title, D.book_writer, D.book_price, C.book_cnt, C.order_status, SUM(book_price * book_cnt) FROM
				(
				SELECT A.order_num, A.user_id, B.book_id, B.book_cnt, A.order_status
				FROM orders A, orderlist B
				WHERE A.order_num = B.order_num
				) C, book D
			WHERE C.book_id = D.book_id
			GROUP BY order_num, book_id WITH ROLLUP
		) E
		WHERE E.book_id = ''
		LIMIT #{end}, 1;
		<!-- end = 30 * pageNum - 1 -->
	</select>
	
	<!-- 주문 30개 -->
	<select id="getOrderList" resultType="OrderPlus">
		SELECT C.order_num, C.user_id, C.book_id, D.book_title, D.book_writer, D.book_price, C.book_cnt, C.order_status FROM
			(
			SELECT A.order_num, A.user_id, B.book_id, B.book_cnt, A.order_status
			FROM orders A, orderlist B
			WHERE A.order_num = B.order_num
			) C, book D
		WHERE C.book_id = D.book_id
		AND #{start} <![CDATA[<]]> C.order_num	
		AND C.order_num <![CDATA[<=]]> #{end}
		<!-- start = 30 * (pageNum - 1) - 1 을 getLastOrderNum에 집어넣었을 때 반환값(주문번호)
			 end   = 30 *  pageNum      - 1 을 getLastOrderNum에 집어넣었을 때 반환값(주문번호)-->
	</select>
	
	<!-- 배송중 상태 변경 -->
	<update id="changeToStart">
		UPDATE order
		SET order_status = '배송중'
		WHERE order_num = #{order_num}
	</update>
	
	<!-- 배송완료 상태 변경 -->
	<update id="changeToEnd">
		UPDATE order
		SET order_status = '배송완료'
		WHERE order_num = #{order_num}
	</update>
	
	<!-- 입금전 상태의 주문 개수 -->
	<select id="getBeforeStartCnt" resultType="_int">
		SELECT COUNT(*)
		FROM orders
		WHERE order_status = '입금전'
	</select>
	
	<!-- 배송중 상태의 주문 개수 -->
	<select id="getStartCnt" resultType="_int">
		SELECT COUNT(*)
		FROM orders
		WHERE order_status = '배송중'
	</select>
	
	<!-- 배송완료 상태의 주문 개수 -->
	<select id="getEndCnt" resultType="_int">
		SELECT COUNT(*)
		FROM orders
		WHERE order_status = '배송완료'
	</select>
	
	<!-- 총 주문 개수 -->
	<select id="getTotCnt" resultType="_int">
		SELECT COUNT(*)
		FROM orders
	</select>

</mapper>